## AWS Organizations 組織管理システム 基本設計書

### 1. 概要
本ドキュメントは、「AWS Organizations 組織管理システム 要件定義書」に基づき、システムの実現方式を定義する基本設計書です。本設計書は、後続の工程である詳細設計および実装のインプットとなることを目的とします。

### 2. システム構成

#### 2.1. システム構成図
`システム構成図.drawio`を参照

#### 2.2. 利用技術・サービス
| 分類 | 技術・サービス名 | 目的 |
| :--- | :--- | :--- |
| **クラウド** | Amazon Web Services (AWS) | インフラ基盤 |
| **IaC** | Terraform | AWSリソースのコードによる宣言的な管理 |
| **組織・アカウント管理**| AWS Organizations | 複数AWSアカウントの一元管理、OU、SCPの適用 |
| **認証・アクセス管理**| AWS IAM Identity Center | 複数AWSアカウントへのシングルサインオン(SSO)の提供 |
| **コスト管理** | AWS Budgets | 予算設定と超過アラート通知 |
| **監査・ログ** | AWS CloudTrail | 全アカウントのAPI操作ログの収集と監査 |
| **セキュリティ監視** | AWS IAM Access Analyzer | 外部公開されたリソースの継続的な検知 |
| | AWS Trusted Advisor | AWSベストプラクティスからの逸脱を検知 |
| **通知** | Amazon Simple Notification Service (SNS) | 各種アラート（コスト、セキュリティ）の管理者への通知 |
| **ストレージ** | Amazon S3 | CloudTrailログ、Terraform状態ファイルの保管 |
| **バージョン管理** | Git (GitHub, AWS CodeCommit等) | Terraform構成コードのバージョン管理と変更履歴の記録 |

#### 2.3. 実行環境・ライブラリ

| コンポーネント | 設定項目 | 設定値 | 備考 |
| :--- | :--- | :--- | :--- |
| **構成管理ツール** | Terraform | 1.x系 | AWS Providerの最新バージョンを利用 |

### 3. 機能設計

#### 3.1. メンバーアカウントのプロビジョニング機能 (F-ORG-001)
*   **処理概要:** Terraformを用いて、標準化された設定を持つ新規AWSアカウントを払い出す。
*   **トリガー:** 開発者によるGitリポジトリへの構成変更のPush、およびCI/CDパイプラインによる`terraform apply`の実行。
*   **入力:** Terraform構成ファイル（`.tf`）に記述されたアカウント情報（アカウント名、メールアドレス、所属OUなど）。
*   **処理シーケンス:**
    1.  管理者が、新規アカウントの定義をTerraform構成ファイル（例: `accounts.tf`）に追加する。
    2.  定義には、アカウント名、ルートユーザーのメールアドレス、および所属させるOU（Organizational Unit）を指定する。
    3.  変更をバージョン管理システム（Git）にプッシュし、プルリクエストを作成してレビューを受ける。
    4.  承認後、CI/CDパイプラインが自動的に`terraform apply`を実行する。
    5.  TerraformがAWS Organizations APIを呼び出し、新しいメンバーアカウントを作成し、指定されたOUに配置する。
*   **出力:** 指定したOUに配置され、後述のガードレールが適用された状態のAWSアカウント。
*   **エラー処理:** `terraform plan`の実行結果をレビューし、意図しない変更が含まれていないか事前に確認する。`apply`失敗時は、CI/CDパイプラインがエラーを通知し、CloudTrailログで原因を調査する。

#### 3.2. 予防的ガードレール機能 (SCP) (F-ORG-002)
*   **処理概要:** Terraformで定義されたサービスコントロールポリシー（SCP）を、組織のルートまたは特定のOUにアタッチし、セキュリティポリシーを強制する。
*   **トリガー:** 開発者によるGitリポジトリへの構成変更のPush、およびCI/CDパイプラインによる`terraform apply`の実行。
*   **入力:** Terraform構成ファイル（`.tf`）にJSON形式で定義されたSCPポリシーの内容。
*   **処理シーケンス:**
    1.  管理者がTerraform構成ファイルにSCPポリシーを定義する (`aws_organizations_policy`)。
        *   **リージョン制限:** `aws:RequestedRegion`条件キーを使用し、許可されたリージョン（`ap-northeast-1`等）以外のアクションを`Deny`するステートメントを記述する。
        *   **特権操作制限:** ルートユーザーからのアクションを`Deny`するステートメントを記述する。(`aws:PrincipalIsRootUser`などの条件キーが考えられるが、SCPでは直接使えないため、`"Principal": {"AWS": "arn:aws:iam::*:root"}`のような条件で制限する)
        *   **セキュリティ設定保護:** `iam:DeleteRole`などの特定のアクションを、特定のIAMロール（例: `OrganizationAccountAccessRole`）に対して`Deny`するステートメントを記述する。
    2.  定義したSCPを対象のOUまたは組織ルートにアタッチする (`aws_organizations_policy_attachment`)。
    3.  CI/CDパイプライン経由で`terraform apply`を実行し、SCPを適用する。
*   **出力:** ポリシーに違反するAPIリクエストに対するAWSからのDeny（拒否）応答。
*   **エラー処理:** 適用前に`terraform plan`でアタッチ対象のOUやポリシー内容を確認する。意図しないアクセス拒否が発生した場合は、CloudTrailログで拒否されたアクションと原因のSCPを特定する。

#### 3.3. 発見的ガードレール機能 (F-ORG-003)
*   **処理概要:** AWS IAM Access AnalyzerとAWS Trusted Advisorを組織レベルで有効化し、リスクや逸脱を継続的に監視・通知する。
*   **トリガー:** 各AWSサービスによる継続的な自動スキャン、および定期的なチェック。
*   **入力:** 各メンバーアカウントのリソース構成情報。
*   **処理シーケンス:**
    1.  **IAM Access Analyzer:**
        a. Terraformを用いて、管理アカウントで組織の委任管理者として設定し、組織レベルのAnalyzer (`aws_accessanalyzer_analyzer`) を有効化する。
        b. Analyzerが意図しない外部アクセスを許可するリソース（S3バケット、IAMロール等）を検出すると、結果（Finding）を生成する。
        c. Amazon EventBridgeルールを設定し、Access Analyzerの新しい結果をトリガーとしてSNSトピックに連携し、管理者にメールで通知する。
    2.  **Trusted Advisor:**
        a. Terraformを用いて、管理アカウントで組織ビューを有効化し、全アカウントのチェック結果を収集可能にする。
        b. (オプション) 定期実行するLambda関数を作成し、Trusted Advisor API (`Support` API) を用いて特定のリスク（例: `Security`カテゴリで`Error`ステータスの項目）を定期的にポーリングする。
        c. Lambdaがリスクを検知した場合、SNSトピックに結果を送信し、管理者に通知する。
*   **出力:** IAM Access Analyzerの検出結果、Trusted Advisorのチェック結果、および管理者へのSNS通知。
*   **エラー処理:** 通知設定の不備は、テストイベントを発行して確認する。各サービスの検出結果の詳細は、AWSマネジメントコンソールで確認する。

#### 3.4. コスト監視・通知機能 (F-ORG-004)
*   **処理概要:** AWS Budgetsを利用し、組織全体のAWS利用料が設定したしきい値を超過した場合、または超過が予測された場合にアラートを送信する。
*   **トリガー:** AWSによるコストデータの集計・更新。
*   **入力:** 組織全体のAWS利用実績および予測データ。
*   **処理シーケンス:**
    1.  管理者がTerraform構成ファイルに`aws_budgets_budget`リソースを定義する。
    2.  リソース定義内で、以下の項目を設定する。
        *   **予算額:** `$10`
        *   **期間:** 月次
        *   **フィルタ:** (なし、組織全体が対象)
        *   **通知設定:**
            *   実績値が予算額の80%に達した場合
            *   予測値が予算額の100%に達した場合
    3.  通知先としてSNSトピックを指定し、そのトピックのサブスクリプションに管理者のメールアドレスを設定する。
    4.  CI/CDパイプライン経由で`terraform apply`を実行し、予算設定を適用する。
*   **出力:** 条件を満たした場合にSNS経由で送信される、管理者へのEメール通知。
*   **エラー処理:** メールが届かない場合は、SNSトピックのサブスクリプションが有効化されているか、アクセスポリシーが適切かを確認する。

#### 3.5. シングルサインオン (SSO) 機能 (F-ORG-005)
*   **処理概要:** AWS IAM Identity Centerを構成し、ユーザーが単一のサインインで複数のAWSアカウントへ安全にアクセスできる環境を提供する。
*   **トリガー:** ユーザーによるSSOポータルへのアクセスとログイン。
*   **入力:** Terraform構成ファイルに定義された権限セット（Permission Set）とアカウント割り当て（Assignment）。
*   **処理シーケンス:**
    1.  **初期設定(手動 or IdP連携):** IAM Identity Centerを有効化し、ユーザーソース（Identity Centerディレクトリ or 外部IdP）を選択する。ユーザーとグループをIdentity Centerディレクトリ内に作成する。
    2.  **IaCによる権限管理:**
        a. Terraformで権限セット (`aws_ssoadmin_permission_set`) を定義する。AWS管理ポリシー（例: `AdministratorAccess`, `ReadOnlyAccess`）やカスタムのインラインポリシーをアタッチする。
        b. Terraformでアカウント割り当て (`aws_ssoadmin_account_assignment`) を定義する。どのプリンシパル（ユーザー or グループ）に、どの権限セットを使い、どのアカウントへアクセスを許可するかを記述する。
    3.  CI/CDパイプライン経由で`terraform apply`を実行し、権限設定を適用する。
    4.  ユーザーは払い出されたSSOポータルURLにアクセスし、サインインすると、割り当てられたアカウントとロール（権限セット）の一覧が表示され、選択してマネジメントコンソールにログインする。
*   **出力:** 各AWSアカウントのマネジメントコンソールへの一時的なセッション。
*   **エラー処理:** ログインできない、または意図した権限がない場合は、IAM Identity Centerのアカウント割り当て設定や、権限セットにアタッチされたポリシー内容を確認する。

### 4. データ設計

#### 4.1. 構成管理データ (Terraform)
*   **役割:** 本管理基盤を構成するすべてのAWSリソースの定義情報をコードとして管理する。
*   **ディレクトリ構成 (例):**
    ```
    .
    ├── main.tf         # プロバイダ定義、バックエンド設定
    ├── variables.tf    # 変数定義
    ├── terraform.tfvars  # 変数値 (Git管理外)
    ├── organization.tf # Organizations, OU, SCPの定義
    ├── identity_center.tf # IAM Identity Centerの権限セット、割り当ての定義
    ├── security.tf     # CloudTrail, Access Analyzer等のセキュリティ関連リソース定義
    └── budget.tf       # AWS Budgetsの定義
    ```
*   **状態ファイル (terraform.tfstate) の管理:**
    *   **バックエンド:** Amazon S3
    *   **役割:** Terraformが管理するリソースの最新状態を記録する。
    *   **設定:**
        *   **S3バケット:** バージョニングとサーバーサイド暗号化（SSE-S3）を有効にする。
        *   **DynamoDBテーブル:** State Lock機能のために使用し、複数人での同時実行による状態ファイルの破損を防ぐ。

#### 4.2. 監査ログデータ設計
*   **役割:** 全アカウントのAPI操作履歴を記録し、セキュリティ監査やインシデント調査に利用する。
*   **データソース:** AWS CloudTrail
*   **データ形式:** JSON
*   **主要な利用項目:** `eventTime`, `eventSource`, `eventName`, `userIdentity` (実行元プリンシパル), `sourceIPAddress`, `requestParameters`, `responseElements`
*   **保管場所:**
    *   **S3バケット:** 管理アカウントに集約されたCloudTrailログ専用のS3バケット。
    *   **設定:** ライフサイクルポリシーを設定し、ログを一定期間（例: 1年）保持した後、低コストのストレージクラス（Glacier）に移行する。バケットへのアクセスは、監査担当者など許可されたロールのみに制限する。

### 5. 非機能要件設計

| 項目 | 設計内容 |
| :--- | :--- |
| **セキュリティ** | 1. **管理アカウントアクセス:** 管理アカウントへの特権操作は、MFAで保護された特定の管理者ロールにSSO経由でスイッチして実行する。通常時は読み取り専用ロールを利用する。 2. **機密情報管理:** AWSアクセスキー等の機密情報はTerraformコードに含めず、CI/CDシステムのSecret管理機能（例: GitHub Actions Secrets）から実行時に環境変数として渡す。 3. **状態ファイル保護:** TerraformのStateファイル保管用S3バケットは、サーバーサイド暗号化(SSE-S3)を有効にし、バケットポリシーでアクセスを厳格に制御する。 4. **認証情報棚卸し:** IAM認証情報レポートを定期的に生成するLambda関数を実装し、90日以上未使用のアクセスキーやMFAが未設定のIAMユーザーを検出し、SNS経由で管理者に通知する。 |
| **信頼性・可用性** | 1. **構成管理:** Gitリポジトリの`main`ブランチを保護ブランチに設定し、変更はすべてプルリクエスト経由でのレビューを必須とする。CI/CDパイプラインで`terraform plan`による影響範囲の確認を自動化し、承認後に`apply`を実行する。 2. **サービス可用性:** 主要構成サービス（Organizations, IAM Identity Center, Route 53, S3）は、AWSが提供する高可用なグローバルサービスまたはマルチAZサービスであり、インフラレベルでの冗長化はAWSに委任する。 |
| **運用・保守性** | 1. **コードの可読性:** `terraform fmt`によるコードフォーマットの統一をCIで強制する。再利用可能なリソース群はTerraformモジュールとして分割し、見通しを良くする。 2. **監査証跡:** 「Gitのコミット履歴（誰が、何を、なぜ変更したか）」、「CI/CDパイプラインの実行ログ（いつ、どのコードが適用されたか）」、「CloudTrail組織証跡（どのAPIが実行されたか）」の3点で変更を追跡可能にする。 3. **テスト容易性:** プルリクエスト作成時に`terraform plan`を自動実行し、変更内容をレビューアが容易に確認できる仕組みを構築する。 |
| **パフォーマンス** | 1. **構成変更の適用時間:** リソースの増加が見込まれる場合は、Terraformの構成ファイルをOUや機能単位で分割し、適用範囲を限定できるように設計する（例: `terraform apply -target=...`の活用やディレクトリ分割）。これにより、変更適用時間を許容範囲内に維持する。 |
| **コスト効率** | 1. **管理コスト:** 本基盤の主要なコスト要因はS3（ログ、Stateファイル保管）、CloudTrail（証跡）、SNS（通知）の利用料となる。これらは従量課金制であり、通常の運用では要件定義の目標値（月額$5未満）を十分に達成可能である。 2. **コスト可視化:** AWS Budgetsによるアラート設定に加え、管理者は定期的にAWS Cost Explorerを利用して、アカウント別・サービス別のコストの内訳を確認し、意図しないコスト増がないかを監視する。 |